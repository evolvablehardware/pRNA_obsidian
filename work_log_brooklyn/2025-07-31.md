## Progress Summary:
**USB Protocol:** 
* Firstly, all of the info that I researched was on the "USB Full-Speed" spec, released with USB-1.0, it is the fastest speed that the Picos support 
	* *(should be quite similar to other USB's, but I didn't look into that that much)*
* Basic breakdown of USB protocol:
	* Host device polls it's peripherals at varying rates depending on what was specified by the device during the initial handshake
	* USB Devices can be made up of a bunch of different kinds of endpoints including:
		* Bulk Data transfer (what we care about)
		* Control
	* A couple of these endpoints are [rolled together](https://stackoverflow.com/questions/60410468/linux-how-to-transfer-data-through-usb-bulk-endpoint-of-cdc-adm-driver-from-us) to make an ACM port for a linux host to interface with
	* The library which handles abstractions of USB functions which is included in Pico-sdk is [TinyUSB](https://github.com/hathach/tinyusb)
	* The pico-ice devs, have done the difficult work of setting up a a TinyUSB config file for the pico in their examples. 
		* The lsusb verbose output of the pico2 config is appended at the bottom of this section
		* **WE WILL LIKELY WANT TO TWEAK THE CONFIG TO INCREASE BUFFER SIZE OF THE DATA ENDPOINTS FOR OUR USECASE**
		* TinyUSB config is done mostly at the project level, relevant constants/config are defined in *tusb_config.h* and *usb_descriptors.c*
* Routing things to the correct endpoint for the data type is handled by the linux ACM driver automatically, and there are libraries such as [pyserial](https://github.com/pyserial/pyserial) for managing these transfers as well.
* Due to the low (by modern PC standards) speeds at which we are transferring data, pyserial is probably fast enough to not be the bottleneck for our transfers

>[!NOTE]- lsusb verbose output specifying 
> ```
>Bus 001 Device 043: ID 1209:b1c0 Generic pico-ice
>Device Descriptor:
>  bLength                18
>  bDescriptorType         1
>  bcdUSB               1.10
>  bDeviceClass          239 Miscellaneous Device
>  bDeviceSubClass         2 [unknown]
>  bDeviceProtocol         1 Interface Association
>  bMaxPacketSize0        64
>  idVendor           0x1209 Generic
>  idProduct          0xb1c0 pico-ice
>  bcdDevice            1.00
>  iManufacturer           1 tinyVision.ai Inc.
>  iProduct                2 pico-ice
>  iSerial                 3 A830D01BAB02C097
>  bNumConfigurations      1
>  Configuration Descriptor:
>    bLength                 9
>    bDescriptorType         2
>    wTotalLength       0x00a8
>    bNumInterfaces          5
>    bConfigurationValue     1
>    iConfiguration          0 
>    bmAttributes         0x80
>      (Bus Powered)
>    MaxPower              500mA
>    Interface Association:
>      bLength                 8
>      bDescriptorType        11
>      bFirstInterface         0
>      bInterfaceCount         2
>      bFunctionClass          2 Communications
>      bFunctionSubClass       2 Abstract (modem)
>      bFunctionProtocol       0 
>      iFunction               0 
>    Interface Descriptor:
>      bLength                 9
>      bDescriptorType         4
>      bInterfaceNumber        0
>      bAlternateSetting       0
>      bNumEndpoints           1
>      bInterfaceClass         2 Communications
>      bInterfaceSubClass      2 Abstract (modem)
>      bInterfaceProtocol      0 
>      iInterface             10 RP2040 logs
>      CDC Header:
>        bcdCDC               1.20
>      CDC Call Management:
>        bmCapabilities       0x00
>        bDataInterface          1
>      CDC ACM:
>        bmCapabilities       0x06
>          sends break
>          line coding and serial state
>      CDC Union:
>        bMasterInterface        0
>        bSlaveInterface         1 
>      Endpoint Descriptor:
>        bLength                 7
>        bDescriptorType         5
>        bEndpointAddress     0x81  EP 1 IN
>        bmAttributes            3
>          Transfer Type            Interrupt
>          Synch Type               None
>          Usage Type               Data
>        wMaxPacketSize     0x0008  1x 8 bytes
>        bInterval              16
>    Interface Descriptor:
>      bLength                 9
>      bDescriptorType         4
>      bInterfaceNumber        1
>      bAlternateSetting       0
>      bNumEndpoints           2
>      bInterfaceClass        10 CDC Data
>      bInterfaceSubClass      0 [unknown]
>      bInterfaceProtocol      0 
>      iInterface              0 
>      Endpoint Descriptor:
>        bLength                 7
>        bDescriptorType         5
>        bEndpointAddress     0x02  EP 2 OUT
>        bmAttributes            2
>          Transfer Type            Bulk
>          Synch Type               None
>          Usage Type               Data
>        wMaxPacketSize     0x0040  1x 64 bytes
>        bInterval               0
>      Endpoint Descriptor:
>        bLength                 7
>        bDescriptorType         5
>        bEndpointAddress     0x82  EP 2 IN
>        bmAttributes            2
>          Transfer Type            Bulk
>          Synch Type               None
>          Usage Type               Data
>        wMaxPacketSize     0x0040  1x 64 bytes
>        bInterval               0
>    Interface Association:
>      bLength                 8
>      bDescriptorType        11
>      bFirstInterface         2
>      bInterfaceCount         2
>      bFunctionClass          2 Communications
>      bFunctionSubClass       2 Abstract (modem)
>      bFunctionProtocol       0 
>      iFunction               0 
>    Interface Descriptor:
>      bLength                 9
>      bDescriptorType         4
>      bInterfaceNumber        2
>      bAlternateSetting       0
>      bNumEndpoints           1
>      bInterfaceClass         2 Communications
>      bInterfaceSubClass      2 Abstract (modem)
>      bInterfaceProtocol      0 
>      iInterface             11 iCE40 UART
>      CDC Header:
>        bcdCDC               1.20
>      CDC Call Management:
>        bmCapabilities       0x00
>        bDataInterface          3
>      CDC ACM:
>        bmCapabilities       0x06
>          sends break
>          line coding and serial state
>      CDC Union:
>        bMasterInterface        2
>        bSlaveInterface         3 
>      Endpoint Descriptor:
>        bLength                 7
>        bDescriptorType         5
>        bEndpointAddress     0x83  EP 3 IN
>        bmAttributes            3
>          Transfer Type            Interrupt
>          Synch Type               None
>          Usage Type               Data
>        wMaxPacketSize     0x0008  1x 8 bytes
>        bInterval              16
>    Interface Descriptor:
>      bLength                 9
>      bDescriptorType         4
>      bInterfaceNumber        3
>      bAlternateSetting       0
>      bNumEndpoints           2
>      bInterfaceClass        10 CDC Data
>      bInterfaceSubClass      0 [unknown]
>      bInterfaceProtocol      0 
>      iInterface              0 
>      Endpoint Descriptor:
>        bLength                 7
>        bDescriptorType         5
>        bEndpointAddress     0x04  EP 4 OUT
>        bmAttributes            2
>          Transfer Type            Bulk
>          Synch Type               None
>          Usage Type               Data
>        wMaxPacketSize     0x0040  1x 64 bytes
>        bInterval               0
>      Endpoint Descriptor:
>        bLength                 7
>        bDescriptorType         5
>        bEndpointAddress     0x84  EP 4 IN
>        bmAttributes            2
>          Transfer Type            Bulk
>          Synch Type               None
>          Usage Type               Data
>        wMaxPacketSize     0x0040  1x 64 bytes
>        bInterval               0
>    Interface Descriptor:
>      bLength                 9
>      bDescriptorType         4
>      bInterfaceNumber        4
>      bAlternateSetting       0
>      bNumEndpoints           0
>      bInterfaceClass       254 Application Specific Interface
>      bInterfaceSubClass      1 Device Firmware Update
>      bInterfaceProtocol      2 
>      iInterface             30 iCE40 DFU (Flash)
>    Interface Descriptor:
>      bLength                 9
>      bDescriptorType         4
>      bInterfaceNumber        4
>      bAlternateSetting       1
>      bNumEndpoints           0
>      bInterfaceClass       254 Application Specific Interface
>      bInterfaceSubClass      1 Device Firmware Update
>      bInterfaceProtocol      2 
>      iInterface             31 iCE40 DFU (CRAM)
>      Device Firmware Upgrade Interface Descriptor:
>        bLength                             9
>        bDescriptorType                    33
>        bmAttributes                        1
>          Will Not Detach
>          Manifestation Intolerant
>          Upload Unsupported
>          Download Supported
>        wDetachTimeout                   1000 milliseconds
>        wTransferSize                     256 bytes
>        bcdDFUVersion                   1.01
>Device Status:     0x0000
>  (Bus Powered)

**Pico-ice and Pico2-ice**
* Different pinouts:
	* Pico-ice Pinouts:
		* [Pico Pins](https://github.com/tinyvision-ai-inc/pico-ice-sdk/blob/main/include/boards/pico_ice.h)
		* [FPGA Pins](https://github.com/tinyvision-ai-inc/pico-ice-sdk/blob/main/rtl/pico_ice.pcf)
	* Pico2-ice Pinouts:
		* [Pico2 Pins](https://github.com/tinyvision-ai-inc/pico-ice-sdk/blob/main/include/boards/pico2_ice.h)
		* [FPGA Pins](https://github.com/tinyvision-ai-inc/pico-ice-sdk/blob/main/rtl/pico2_ice.pcf)



**Micropython**:
* Super slow to do the kind of thing that we care about (raw binary, fixed size file copying, usb transfer of said files)
* No linting makes development more difficult
* More complicated to implement the custom USB-stack that we care about.
* Was useful for initial function testing, but not much else

## Remaining Tasks:
* Benchmark USB potential speed (estimated):
	* Compile and use picotool and then use following command to check the flashing speed for a complete uf2 file including a .bin header:
	  `picotool load <uf2FilePath> --force --execute`
		- -f, --force 
		  (Force a device not in BOOTSEL mode but running compatible code to reset so the command can be executed. After executing the command (unless the command itself is a 'reboot') the device will be rebooted back to application mode)
		- -x --execute 
		  (Attempt to execute the downloaded file as a program after the load)
	- I planned to use the basic bash `time` utility to just check how long the command takes to complete and divide the uf2 filesize by that duration. I think it should be a realistic estimate of usb bulk transfers.


## Next
- [ ]

[[2025-07-30|prev]] [[2025-08-01|next]]
