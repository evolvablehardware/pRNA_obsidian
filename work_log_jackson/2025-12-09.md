## Log
- Towards removing privileged mode
	- https://stackoverflow.com/questions/56362502/access-multiple-devices-in-docker-container-without-privileged-flag
			- in compose
			- https://stackoverflow.com/questions/48498827/how-to-pass-device-cgroup-rule-by-docker-compose
			- not supported in compose v3, which is needed for swarm (AHHHH)
				- https://github.com/docker/compose/pull/6974
				- https://github.com/torizon/vscode-torizon-templates/issues/163 nevermind maybe?
				- NOPE
			
		- This works with dynamic devices (using --device does not work because devices will be added/removed), but does **not** let us bind to the usbip driver
			- usbip: debug: sysfs_utils.c:18:[write_sysfs_attribute] error opening attribute /sys/bus/usb/drivers/usb/unbind
			- adding sys as a volume does not fix this
			- https://forums.docker.com/t/unable-to-mount-sys-inside-the-container-with-rw-access-in-unprivileged-mode/97043
			- sys is mounted as rw, nosuid, nodev, noexec, relatime
			
		- This is a dead end, not supported with swarm

	- I'ts possible to add devices using udev rules, which makes cgroup uneccessary, Brooklyn has done this before. Focusing on getting usbip working.
	
	- docker run --device=/dev/ttyACM0 -it --rm -v /sys:/sys -v /lib/modules:/lib/modules usbipiceproject/usbipice-worker:noble-20240423-generic bash
		- Had to add a bunch of permissions for usbip-host module drivers. Essentially just ran usbip bind --debug and chmod 0777 on the error until it worked
		- **This requires [sysbox](https://github.com/nestybox/sysbox) instead of runc**
		- Using sysbox means we cannot use -v /dev:/dev
		- I don't think this will work 
		
	- docker run  -it --rm -v /sys:/sys -v /lib/modules:/lib/modules -v /run/udev:/run/udev -v /dev:/dev --security-opt apparmor=unconfined --user root --security-opt systempaths=unconfined  --runtime runc  usbipiceproject/usbipice-worker:noble-20240423-generic bash
		- Not sure if this is able to be done from compose. Doesn't use sysbox.
		- Not available with swarm

- I think I might actually be okay to not use swarm and instead continue with pdsh? The main reason why I decided to make the change was because adding other services (logging) would be extremely annoying. If the only other service we have to worry about is the control server, its not really that bad. If this turns out to be too annoying, these are the routes that we can still go:
	- Figure out devs for sysbox. When mapping -v /dev:/dev, error message about not being able to access /dev/ptmx is thrown. If we mount to a different dir, permissions are set to nobody; nogroup.
	- Figure out usbip (or drop support) with runc. There's a dockercli fork that is supposed to add security opt options. I'm unfamiliar with go and have not been able to compile it yet
	- Kubernetes 
- Updated usage documentation for worker/control/client
- Moved to logging using control endpoint
## Next
- Make control endpoint for logging instead of elk

[[work_log_jackson/2025-12-08|prev]] [[work_log_jackson/2025-12-10|next]]
