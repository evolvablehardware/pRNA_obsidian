## Log
- GP issue
	- The extra latency is causing some issues during flashing. I suspect that both the dev event listener and the device scan is picking up the sdx1 dev and are both trying to mount it, causing one of them to stall. 
	- This is not the case. On some occasions, after the firmware is uploaded and the device reconnects to usbip, the wrong devices are exported. That is, the sd device is shown as available instead of ACM0. This is not the case and trying to access the file says it does not exist. I can also see the correct device being exported on the worker log. I tried further delaying the time between the usbip bind and the client notification push, which seems have solved the issue.
	- After this state is reached, if the device is bound again, it seems to work as intended, might be just chance though?
	- Few ways to go about this, assuming the rebind always works:
		- Try to find a way to detect this with kernel events on the worker side, trigger a rebind. This is the best case scenario.
		- Add an endpoint to trigger a rebind the client can use. This is kind of messy.
		- Ignore the problem! This seems to only happen with the high network latency, so for now I can keep the delay high for demo purposes and reduce it when deployed on the same network.
			- For now I'm going to do this, as it doesn't seem to be a real issue without it. 
		- Right now, when we get the bind notification, we immediately bind the device - we don't check the list of available devices. I wonder if there is a brief window where the device is not in this list as ready to go but can still be connected to that causes the issue. I wonder if we try listing the available devices first, and only connecting once it shows, it would solve the issue.
- Started tracking issues
- After doing some more testing, I've gotten the weird usbip state a few times on local network. Going to look into the kernel events detection.
	- I'm starting to doubt my initial analysis. I have not been able to reproduce the issue again.
	- Reserving devices...
		bound device BB26BACCA68C3D58 on (ip):1-1.2
		bound device 0B2136D98D7DA257 on (ip):1-1.1
		Successfully reserved 2 devices.
		Flashing devices...
		device BB26BACCA68C3D58 disconnected
		bound device BB26BACCA68C3D58 on (ip):1-1.2
		device 0B2136D98D7DA257 disconnected
		bound device 0B2136D98D7DA257 on (ip):1-1.1
		bound device BB26BACCA68C3D58 on (ip):1-1.2
        device BB26BACCA68C3D58 disconnected
	- It seems that the bind event is happening before the disconnect one
	- [[worker_log_usbip_disconnect]]
	- I think its an issue with the event order being desynced?
		- This is not the case - right now the disconnect event is mainly for notifications. It's still weird that its happening. I'm going to try adding an unbind when disconnects happen. This should fix the issue, as this causes a force rebind. This may cause other issues though. I'm worried it has the potential for recursion given that the disconnect detection is kinda unreliable.
			- This doesn't seem to have changed anything
		- It seems that the device enters a state where the host thinks that it is connected, but the client is not connected to it - usbip host shows no attached devices but usbip attached says the device is already exported.
		- I don't think we can detect this happening from the worker. Two options:
			- Track dev events on the client. If we have no devices from a pico for an amount of time, send a rebind request to the worker.
				- Going to try to do this one, not sure if it will work though.
			- Poll usbip port, rebind if disconnected for a while.
## Next
- [ ]

[[work_log_jackson/2025-11-12|prev]] [[work_log_jackson/2025-11-14|next]]
